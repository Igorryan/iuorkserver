generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum UserRole {
  CLIENT
  PRO
}

enum BookingStatus {
  REQUESTED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PricingType {
  FIXED
  HOURLY
  BUDGET
}

model User {
  id           String   @id @default(uuid())
  role         UserRole
  name         String
  phone        String?  @unique
  email        String?  @unique
  passwordHash String?
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  professionalProfile ProfessionalProfile?
  bookingsClient      Booking[]            @relation("BookingClient")
  bookingsPro         Booking[]            @relation("BookingPro")
  reviewsFrom         Review[]             @relation("ReviewFrom")
  reviewsTo           Review[]             @relation("ReviewTo")
  chatsAsClient       Chat[]               @relation("ChatClient")
  chatsAsProfessional Chat[]               @relation("ChatProfessional")
  messages            Message[]
}

model ProfessionalProfile {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @unique
  bio        String?
  coverUrl   String?
  radiusKm   Int      @default(5)
  latitude   Decimal? @db.Decimal(9, 6)
  longitude  Decimal? @db.Decimal(9, 6)
  city       String?
  state      String?
  street     String?
  number     String?
  district   String?
  postalcode String?
  profession Profession? @relation(fields: [professionId], references: [id])
  professionId String?
  isOnline   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  services   Service[]
  categories Category[] @relation("ProfessionalCategories")
  availabilities Availability[]
}

model Category {
  id        String     @id @default(uuid())
  name      String     @unique
  imageUrl  String?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  parentId  String?
  children  Category[] @relation("CategoryHierarchy")

  services      Service[]
  professionals ProfessionalProfile[] @relation("ProfessionalCategories")
}

model Service {
  id             String              @id @default(uuid())
  professional   ProfessionalProfile @relation(fields: [professionalId], references: [id])
  professionalId String
  title          String
  description    String
  pricingType    PricingType         @default(BUDGET)
  price          Decimal?            @db.Decimal(10, 2)
  isOnline       Boolean             @default(false)
  isPresential   Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  category   Category?      @relation(fields: [categoryId], references: [id])
  categoryId String?
  images     ServiceImage[]
  bookings   Booking[]
  reviews    Review[]
  chats      Chat[]
}

model ServiceImage {
  id        String  @id @default(uuid())
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId String
  url       String
}

model Booking {
  id             String        @id @default(uuid())
  client         User          @relation("BookingClient", fields: [clientId], references: [id])
  clientId       String
  professional   User          @relation("BookingPro", fields: [professionalId], references: [id])
  professionalId String
  service        Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId      String
  status         BookingStatus @default(REQUESTED)
  scheduledAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Local de execução (apenas lat/lng por compatibilidade com clients)
  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)
  address   String?
}

model Review {
  id         String   @id @default(uuid())
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId  String
  fromUser   User     @relation("ReviewFrom", fields: [fromUserId], references: [id])
  fromUserId String
  toUser     User     @relation("ReviewTo", fields: [toUserId], references: [id])
  toUserId   String
  rating     Int
  comment    String
  createdAt  DateTime @default(now())
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
}

enum BudgetStatus {
  PENDING
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
}

model Chat {
  id             String   @id @default(uuid())
  client         User     @relation("ChatClient", fields: [clientId], references: [id])
  clientId       String
  professional   User     @relation("ChatProfessional", fields: [professionalId], references: [id])
  professionalId String
  service        Service? @relation(fields: [serviceId], references: [id])
  serviceId      String?
  budget         Budget?  @relation("BudgetChat")
  lastMessageAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages Message[]

  @@index([clientId])
  @@index([professionalId])
  @@index([lastMessageAt])
}

model Message {
  id            String      @id @default(uuid())
  chat          Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId        String
  sender        User        @relation(fields: [senderId], references: [id])
  senderId      String
  content       String?
  messageType   MessageType @default(TEXT)
  mediaUrl      String?
  audioDuration Int?
  isRead        Boolean     @default(false)
  createdAt     DateTime    @default(now())

  @@index([chatId, createdAt])
  @@index([senderId])
}

model Budget {
  id          String       @id @default(uuid())
  chat        Chat         @relation("BudgetChat", fields: [chatId], references: [id], onDelete: Cascade)
  chatId      String       @unique
  serviceId   String
  price       Decimal      @db.Decimal(10, 2)
  description String?
  status      BudgetStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  expiresAt   DateTime?

  @@index([serviceId])
  @@index([status])
}

model ProfessionCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique // construction, maintenance, etc.
  icon      String?  // Nome do ícone
  color     String?  // Cor hexadecimal
  imageUrl  String?  // URL da imagem da categoria
  orderIndex Int     @default(0) // Ordem de exibição
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professions Profession[]
}

model Profession {
  id        String   @id @default(uuid())
  name      String   @unique
  imageUrl  String?  // URL da imagem da profissão
  category  ProfessionCategory? @relation(fields: [categoryId], references: [id])
  categoryId String?
  orderIndex Int     @default(0) // Ordem de exibição dentro da categoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professionals ProfessionalProfile[]
}

model Availability {
  id             String              @id @default(uuid())
  professional   ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  professionalId String
  
  // Tipo de disponibilidade: WEEKLY (recorrente por dia da semana) ou SPECIFIC (data específica)
  type           String              @default("WEEKLY") // "WEEKLY" ou "SPECIFIC"
  
  // Para tipo WEEKLY: 0 (domingo) a 6 (sábado)
  // Para tipo SPECIFIC: data específica
  dayOfWeek      Int?                // 0-6 para WEEKLY
  specificDate   DateTime?           // Para SPECIFIC
  
  // Horários de disponibilidade (formato HH:mm)
  startTime      String              // Ex: "09:00"
  endTime        String              // Ex: "18:00"
  
  // Se está ativo
  isActive       Boolean             @default(true)
  
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([professionalId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([isActive])
}
